# 完整 Spec 补充建议

> 针对 [discussion.md](discussion.md) 支撑完整规格说明时的缺口与待确认项，给出可执行建议，供讨论会拍板或直接采纳。

---

## 1. 「完整 spec」的目标建议

**建议：选 B（可开发、可验收的规格），但首版 NFR 从简。**

- 理由：discussion 已具备方案与设计深度，只差「接口 + 数据 + 验收」即可闭环；写清契约能减少联调歧义、便于分工。
- 做法：
  - 在 `docs/` 下新增 **spec.md**（或 `需求规格说明.md`），结构上包含：功能需求（可直接引用 discussion §2）、接口规格、数据约定、验收标准、NFR（简短）。
  - NFR 首版只写：响应超时（如单轮 < 60s）、错误时友好提示、不接真实成绩与敏感数据；性能/并发可写「演示场景无硬性指标，后续迭代补充」。

---

## 2. Agent API 与前端接口建议

**建议：在 spec 中给出一份「建议契约」，由讨论会确认后定稿。**

首版建议约定以下内容，便于 Web（Dash）与 Agent 联调：

| 项 | 建议 |
|----|------|
| **协议** | REST；单轮对话用 POST，如需多轮则请求体带 `session_id`。 |
| **请求** | `POST /chat` 或 `/api/chat`，Body：`{ "session_id": "uuid", "message": "用户输入" }`；`session_id` 可选，缺省则由服务端生成并随响应返回。 |
| **响应** | `{ "reply": "助手回复", "citations": [{ "source": "...", "page": "..." }], "recommendations": [{ "type": "learn"|"exercise", "reason": "...", "target": "..." }], "session_id": "uuid" }`；任一字段可缺省（如无推荐则为空数组）。 |
| **错误** | HTTP 4xx/5xx；Body 统一为 `{ "error": "code", "message": "可展示说明" }`，如 `rate_limit`、`model_error`、`timeout`。 |

前端与后端仅通过该 API 交互；RAG/图谱对 Agent 的接口可视为内部实现，不在 spec 中暴露，除非多人分工时需约定边界。

---

## 3. 数据 Schema 建议

**建议：在 spec 中固定「最小 schema」，由实现方遵守；你方评审后采纳或微调。**

**向量库 chunk metadata（最小集）**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| source | string | 是 | 来源标识，如文件名或 resource id。 |
| page | string 或 int | 否 | 页码，用于引用「第 X 页」。 |
| chapter | string | 否 | 章节标识，如 "Lecture 8" 或 "3.2"。 |

检索返回的每条 chunk 必须带上述 metadata，供生成引用时使用。

**Neo4j 知识图谱（首版最小）**

- **节点**：`Topic`，属性建议 `id`, `name`, `order`（讲序）, `difficulty`（可选）。
- **边**：`PREREQUISITE`（先修），如 `(Topic A)-[:PREREQUISITE]->(Topic B)` 表示 A 为 B 的先修。
- **习题关联**：若首版做推荐练习，可增加节点 `Exercise` 与边 `(Topic)-[:COVERS]->(Exercise)` 或等价关系。

在 spec 中写清上述节点/边及 1～2 条示例 Cypher（如「按 topic_id 查先修」「按 topic 查推荐练习」），实现时按此建模即可。

**会话持久化 JSONL**

若做会话落盘，建议单条结构：`{ "session_id": "", "role": "user"|"assistant"|"tool", "content": ""|{}, "timestamp": "" }`，与 LangChain 消息结构可映射即可，不必强求与某库完全一致。

---

## 4. 验收与演示建议

**建议：在 spec 中增加「演示用例集」，用于验收和 8 分钟视频；用例由你们根据课程重点定稿。**

- **数量**：5～8 个用例即可，覆盖：纯概念答疑、带页码/章节引用、推荐下一步学习、推荐练习、以及 1 个「无结果/边界」示例（如偏题问题）。  
- **格式**：每个用例包含「输入问题」「预期行为」（含是否出现引用、是否出现推荐）、「验收通过条件」（如「回答中须包含至少一处 citation」）。  
- **责任**：初版用例可由技术方根据 discussion 与教材目录起草，由课程/产品侧确认或补充；定稿后写入 spec 的「验收标准」小节，作为演示脚本与视频提纲。

这样「RAG 管道跑通」「图谱可查询」「Agent + 两 Skill 端到端」都有可检查的用例，避免口头约定。

---

## 5. 双 Skill 与异常行为建议

**建议：在 spec 中简短约定，便于实现一致、体验可预期。**

| 场景 | 建议约定 |
|------|----------|
| **双 Skill 同时触发** | 首版采用「合并回答」：同一轮既做答疑又做推荐；若用户问题同时包含概念与「推荐练习」意图，则先给答疑+引用，再给推荐理由与建议，顺序在 system prompt 中说明。不在首版做「只选一个 Skill」的互斥逻辑。 |
| **苏格拉底式追问** | spec 中写为「可选行为」：在 SKILL.md/提示词中允许助手在合适时机用引导式提问，但不做强制触发条件；首版以「先解释+引用」为主，追问不写进验收标准。 |
| **RAG 无结果** | 约定助手回复中须包含「未在课程材料中找到直接相关内容」类说明，并建议用户换表述或说明章节；不编造出处。 |
| **图谱无推荐** | 约定可返回空推荐列表，助手说明「暂无针对性的下一步推荐」或提示用户先完成当前知识点。 |
| **LLM/API 超时或限流** | 在「错误与降级」中约定：返回统一错误码与友好提示（如「服务暂时繁忙，请稍后再试」）；若已实现备用模型，可注明「自动切换备用模型重试一次」。 |

上述内容可在 spec 的「行为约定」或「异常与边界」小节中写 1 页以内，与 discussion 的「首版以…为主」保持一致。

---

## 6. 建议的 Spec 文档结构（供新建时参考）

在 `docs/` 下新建 spec 时，可采用如下结构，便于与 discussion 对齐并覆盖缺口：

1. **概述**：目标、范围、术语（可引用 discussion §1、§2）。  
2. **功能需求**：主场景与首版/可选/不做（直接引用 discussion §2）。  
3. **接口规格**：Agent API 请求/响应/错误（采用本文 §2 建议）。  
4. **数据约定**：RAG metadata、Neo4j 最小 schema、会话 JSONL（采用本文 §3）。  
5. **行为与边界**：双 Skill、无结果、超时与降级（采用本文 §5）。  
6. **验收标准**：演示用例集 + 通过条件（采用本文 §4）。  
7. **非功能需求（简）**：超时、错误提示、数据与安全原则（采用本文 §1）。  
8. **参考**：discussion.md、Project.md、功能设计说明-非技术版.md。

按上述方式补充后，discussion 与 spec 一起即可支撑「完整可落地的规格说明」；讨论会只需对建议做确认或微调，无需从零起草。
